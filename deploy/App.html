<!DOCTYPE html>
<html>
<head>
    <title>ProjectBurnChart</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ActualCalculator",{extend:"Rally.data.lookback.calculator.BaseCalculator",runCalculation:function(snapshots){for(var completedIterationTotals={},completedStoryIterations={},incompleteIterationTotals={},oldTotal,iteration,iterationName,s=0,l=snapshots.length;l>s;s++){var snapshot=snapshots[s],objectID=snapshot.ObjectID,iterations=this.getMatchingIterations(snapshot);if(0!==iterations.length)if("Accepted"===snapshot.ScheduleState)iteration=iterations[0],iterationName=iteration.get("Name"),snapshot._PreviousValues&&snapshot._PreviousValues.ScheduleState!==void 0&&!completedStoryIterations[objectID]&&(completedStoryIterations[objectID]=iteration,oldTotal=completedIterationTotals[iterationName]||0,completedIterationTotals[iterationName]=oldTotal+snapshot.PlanEstimate);else for(var iter=0,iterL=iterations.length;iterL>iter;iter++)iteration=iterations[iter],iterationName=iteration.get("Name"),oldTotal=incompleteIterationTotals[iterationName]||0,incompleteIterationTotals[iterationName]=oldTotal+snapshot.PlanEstimate}for(var actualSeriesData=[],cumulativeActuals=0,cumulativeActualSeriesData=[],backlogRemainingSeriesData=[],devIncreaseSeriesData=[],devIncrease,previousBacklogRemaining=null,categories=[],pastIteration=!0,today=(new Date).getTime(),i=0,il=this.iterations.length;il>i;i++){iteration=this.iterations[i];var iterationStart=iteration.get("StartDate").getTime();pastIteration=today>=iterationStart,iterationName=iteration.get("Name");var completedIterationTotal=completedIterationTotals[iterationName]||0;actualSeriesData.push(completedIterationTotal),cumulativeActuals+=completedIterationTotal,pastIteration&&cumulativeActualSeriesData.push(cumulativeActuals);var backlogRemaining=incompleteIterationTotals[iterationName]||0;backlogRemainingSeriesData.push(backlogRemaining),0===i?devIncreaseSeriesData.push(0):(devIncrease=Math.max(backlogRemaining-previousBacklogRemaining+completedIterationTotal,0),devIncreaseSeriesData.push(devIncrease)),previousBacklogRemaining=backlogRemaining;var endLabel=Rally.util.DateTime.formatWithDefault(iteration.get("EndDate")),iterationLabel=iteration.get("Name")+"<br/>"+endLabel;categories.push(iterationLabel)}var backlogBurnProjectionSeriesData=this.calculateBacklogBurnProjection(backlogRemainingSeriesData,actualSeriesData,categories);return{series:[{name:"Dev Total (Accepted Points per iteration)",data:cumulativeActualSeriesData},{name:"Backlog Remaining (Points per iteration)",data:backlogRemainingSeriesData},{name:"Burn down projection",type:"line",data:backlogBurnProjectionSeriesData},{name:"Dev Increase (Points per iteration)",data:devIncreaseSeriesData}],categories:categories}},calculateCapacityBurn:function(){for(var iterationRef,iterationCapacities={},c=0,l=this.capacities.length;l>c;c++){var capacity=this.capacities[c];iterationRef=capacity.get("Iteration")._ref;var oldTotal=iterationCapacities[iterationRef]||0;iterationCapacities[iterationRef]=oldTotal+capacity.get("Capacity")}for(var data=[0],remainingCapacity=0,i=this.iterations.length-1;i>0;i--){var iteration=this.iterations[i];iterationRef=iteration.get("_ref");var iterationCapacity=iterationCapacities[iterationRef]||0;remainingCapacity+=iterationCapacity,data.unshift(remainingCapacity)}return data},calculateBacklogBurnProjection:function(backlogRemainingSeriesData,actualSeriesData,categories){for(var twoWeeksInMillis=12096e5,backlogRemaining=null,data=[],last3AverageActuals,lastIterationModel=this.iterations[this.iterations.length-1],lastIteration={endDate:lastIterationModel.get("EndDate")},today=(new Date).getTime(),lastRealIterationIndex=null,i=0,l=this.iterations.length;l>i;i++){var iteration=this.iterations[i],iterationBeforeToday=today>=iteration.get("EndDate").getTime();if(!iterationBeforeToday||i===l-1){last3AverageActuals=0;for(var actualCount=0,j=lastRealIterationIndex-2;lastRealIterationIndex>=j;j++)0>j||(last3AverageActuals+=actualSeriesData[j],actualCount++);last3AverageActuals/=actualCount}iterationBeforeToday?(backlogRemaining=backlogRemainingSeriesData[i],lastRealIterationIndex=i):backlogRemaining-=last3AverageActuals,0>=backlogRemaining?data.push(null):data.push(backlogRemaining)}for(;backlogRemaining>0;){lastIteration={endDate:new Date(lastIteration.endDate.getTime()+twoWeeksInMillis)};var iterationLabel=Rally.util.DateTime.formatWithDefault(lastIteration.endDate);categories.push(iterationLabel),console.log("last3AverageActuals",last3AverageActuals),backlogRemaining-=last3AverageActuals,data.push(backlogRemaining)}return data},getMatchingIterations:function(snapshot){for(var matches=[],i=0,l=this.iterations.length;l>i;i++){var iteration=this.iterations[i],iterationEnd=Rally.util.DateTime.toIsoString(iteration.get("EndDate"),!0),iterationStart=iteration.get("StartDate").getTime(),today=(new Date).getTime();iterationEnd>=snapshot._ValidFrom&&snapshot._ValidTo>iterationEnd&&today>=iterationStart&&matches.push(iteration)}return matches}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",launch:function(){this.setLoading(!0);var projectRef=this.getContext().getProjectRef(),projectOid=this.getContext().getProject().ObjectID;this.loadIterations(projectRef,projectOid)},loadIterations:function(projectRef,projectOid){var app=this,iterationStore=Ext.create("Rally.data.WsapiDataStore",{model:"Iteration",context:{project:projectRef,projectScopeUp:!1,projectScopeDown:!1},filters:[{property:"Project",value:projectRef}],sorters:[{property:"EndDate",direction:"ASC"}]}),iterationsPromise=iterationStore.load();iterationsPromise.then({success:function(iterations){for(var iterationFilters=[],i=0,l=iterations.length;l>i;i++)iterationFilters.push({property:"Iteration",value:iterations[i].get("_ref")});var capacityStore=Ext.create("Rally.data.WsapiDataStore",{model:"useriterationcapacity",context:{project:projectRef,projectScopeUp:!1,projectScopeDown:!1},filters:Rally.data.QueryFilter.or(iterationFilters),fetch:["Capacity","Iteration"]}),capacityPromise=capacityStore.load();capacityPromise.then({success:function(capacities){app.loadChart(iterations,capacities,projectOid),this.setLoading(!1)},failure:function(error){console.log("Failed to load iteration capacities"),console.log(error)}})},failure:function(error){console.log("Failed to load iterations for project '"+projectRef+"'"),console.log(error)}})},loadChart:function(iterations,capacities,projectOid){var chart={xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:{find:{Project:projectOid,_TypeHierarchy:"HierarchicalRequirement",Children:null},fetch:["PlanEstimate","ObjectID","ScheduleState","_ValidFrom","_ValidTo","_PreviousValues"],hydrate:["ScheduleState"],sort:{_ValidFrom:-1}},calculatorType:"ActualCalculator",calculatorConfig:{iterations:iterations,capacities:capacities},chartColors:["#009933","#254361","#FF0000","#A40000"],chartConfig:{chart:{type:"column"},title:{text:"Project Iteration Burn Chart"},xAxis:{},yAxis:{min:0,title:{text:"Total story points"}},plotOptions:{column:{stacking:"normal",borderWidth:0},line:{connectNulls:!0,lineWidth:1,marker:{radius:2.5}}},tooltip:{shared:!0}}};this.add(chart)}});

            Rally.launchApp('CustomApp', {
                name:"ProjectBurnChart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
