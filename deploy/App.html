<!DOCTYPE html>
<html>
<head>
    <title>ProjectBurnChart</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ActualCalculator",{extend:"Rally.data.lookback.calculator.BaseCalculator",runCalculation:function(snapshots){for(var completedIterationTotals={},completedStoryIterations={},incompleteIterationTotals={},oldTotal,iteration,iterationName,s=0,l=snapshots.length;l>s;s++){var snapshot=snapshots[s],objectID=snapshot.ObjectID,iterations=this.getIterations(snapshot);if(0!==iterations.length)if("Accepted"===snapshot.ScheduleState)iteration=iterations[0],iterationName=iteration.get("Name"),snapshot._PreviousValues&&snapshot._PreviousValues.ScheduleState!==void 0&&!completedStoryIterations[objectID]&&(completedStoryIterations[objectID]=iteration,oldTotal=completedIterationTotals[iterationName]||0,completedIterationTotals[iterationName]=oldTotal+snapshot.PlanEstimate);else for(var iter=0,iterL=iterations.length;iterL>iter;iter++)iteration=iterations[iter],iterationName=iteration.get("Name"),oldTotal=incompleteIterationTotals[iterationName]||0,incompleteIterationTotals[iterationName]=oldTotal+snapshot.PlanEstimate}for(var actualSeriesData=[],backlogRemainingSeriesData=[],devIncreaseSeriesData=[],devIncrease,previousBacklogRemaining=null,categories=[],i=0,il=this.iterations.length;il>i;i++){iteration=this.iterations[i],iterationName=iteration.get("Name");var completedIterationTotal=completedIterationTotals[iterationName]||0;actualSeriesData.push(completedIterationTotal);var backlogRemaining=incompleteIterationTotals[iterationName]||0;backlogRemainingSeriesData.push(backlogRemaining),0===i?devIncreaseSeriesData.push(0):(devIncrease=Math.min(backlogRemaining-previousBacklogRemaining+completedIterationTotal,0),devIncreaseSeriesData.push(devIncrease),previousBacklogRemaining=backlogRemaining);var endLabel=Rally.util.DateTime.formatWithDefault(iteration.get("EndDate")),iterationLabel=iteration.get("Name")+"<br/>"+endLabel;categories.push(iterationLabel)}return{series:[{name:"Dev Incrase (Points per iteration)",data:devIncreaseSeriesData},{name:"Actual (Accepted Points per iteration)",data:actualSeriesData},{name:"Backlog Remaining (Points per iteration)",data:backlogRemainingSeriesData}],categories:categories}},getIterations:function(snapshot){for(var matches=[],i=0,l=this.iterations.length;l>i;i++){var iteration=this.iterations[i],iterationEnd=Rally.util.DateTime.toIsoString(iteration.get("EndDate"),!0);iterationEnd>=snapshot._ValidFrom&&snapshot._ValidTo>iterationEnd&&matches.push(iteration)}return matches}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",launch:function(){this.setLoading(!0);var projectRef="/projects/11229304031",projectOid=11229304031;this.loadIterations(projectRef,projectOid)},loadIterations:function(projectRef,projectOid){var app=this,iterationStore=Ext.create("Rally.data.WsapiDataStore",{model:"Iteration",context:{project:projectRef,projectScopeUp:!1,projectScopeDown:!1},filters:[{property:"Project",value:projectRef}],sorters:[{property:"EndDate",direction:"ASC"}]}),iterationsPromise=iterationStore.load();iterationsPromise.then({success:function(records){app.loadChart(records,projectOid),this.setLoading(!1)},failure:function(error){console.log("Failed to load iterations for project '"+projectRef+"'"),console.log(error)}})},loadChart:function(iterations,projectOid){var chart={xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:{find:{Project:projectOid,_TypeHierarchy:"HierarchicalRequirement",Children:null},fetch:["PlanEstimate","ObjectID","ScheduleState","_ValidFrom","_ValidTo","_PreviousValues"],hydrate:["ScheduleState"],sort:{_ValidFrom:-1}},calculatorType:"ActualCalculator",calculatorConfig:{iterations:iterations},chartConfig:{chart:{type:"column"},title:{text:"Project Iteration Burn Chart"},xAxis:{},yAxis:{min:0,title:{text:"Total story points"}},plotOptions:{column:{stacking:"normal"}}}};this.add(chart)}});

            Rally.launchApp('CustomApp', {
                name:"ProjectBurnChart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
